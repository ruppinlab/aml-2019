# 

Load libraries.
```{r}
library(biomaRt)
library(survival)
library(RegParallel)
library(survminer)
library(matrixStats)
library(ggplot2)
library(ggrepel)
require(statar) # for xtile
```

Set directories.
```{r}
dir.output <- "~/datasets/SLpediatric/sl_pairs_results/"
dir.figures <- "~/Google Drive/NIH_NCI/Projects/AML_pediatric/figures/"
dir.code <- "~/datasets/SLpediatric/R/"
dir.repo <- "~/src/SLpediatric/R/"
dir.rdata <- "~/datasets/SLpediatric/Rdata_object/version6_nbl1-3/"
dir.ppi <- "~/datasets/STRING/"
dir.depmap <- "~/datasets/DepMap/"
dir.aml <- "~/datasets/SLpediatric/Rdata_object/version7_aml/"
dir.target <- "/Users/schischlikf2/datasets/SLpediatric/datasets/TARGET/"
```

Recurrent used functions.
```{r}

subset.prob.tcga <- function(prob, ix){
  
  prob$samples=prob$samples[ix]
  prob$types=prob$types[ix]
  prob$mRNA=prob$mRNA[,ix]
  prob$scna=prob$scna[,ix]
  prob$mRNAq=prob$mRNAq[,ix]
  prob$scnaq=prob$scnaq[,ix]
  prob$mRNAq2=prob$mRNAq2[,ix]
  prob$scnaq2=prob$scnaq2[,ix]
  prob$sex=prob$sex[ix]
  prob$age=prob$age[ix]
  prob$race=prob$race[ix]
  prob$survival=prob$survival[ix,]
  prob$stage=prob$stage[ix]
  prob$mRNA.norm=prob$mRNA.norm[,ix]
  prob$scna.norm=prob$scna.norm[,ix]
  prob$surv.dt=prob$surv.dt[ix,]
  
  return(prob)
}

subset.genes.prob.target <- function(prob, ix){
  prob$genes <- prob$genes[ix]
  prob$ensembl <- prob$ensembl[ix]
  prob$ensembl_version <- prob$ensembl_version[ix]
  prob$scna <- prob$scna[ix, ]
  prob$mRNA <- prob$mRNA[ix, ]
  prob$samples <- prob$samples
  prob$types <- prob$types
  prob$mutations <- prob$mutations
  prob$sex <- prob$sex
  prob$age <- prob$age
  prob$race <- prob$race
  prob$ethnicity <- prob$ethnicity
  prob$survival <- prob$survival
  prob$eventfree <- prob$eventfree
  
  return(prob) 
}

```

Load data.
```{r}
# load depmap data
load(paste(dir.depmap, "depmap_19Q3.RData", sep=""))
# load TCGA data
load(paste(dir.code, "prob.TCGA.extended.qnorm.RData", sep=""));prob0=prob
rm(prob)
# load TARGET data
load(paste(dir.aml, "aml.fpkms.n145.hg38.prob.Rdata", sep="")) # prob_name=aml.fpkms.prob.hg38

```

Preprocess TARGET data.
```{r}
# only select protein coding genes
aml.fpkms.prob.hg38$ensembl_version <- aml.fpkms.prob.hg38$ensembl
aml.fpkms.prob.hg38$ensembl <- sapply(
  aml.fpkms.prob.hg38$ensembl_version, 
  function(x) strsplit(as.character(x), split="\\.")[[1]][1])
row.names(aml.fpkms.prob.hg38$mRNA) <- aml.fpkms.prob.hg38$ensembl

ensembl <- useMart(
  "ensembl", 
  dataset="hsapiens_gene_ensembl")

gene_biotype <- getBM(
  attributes = c('ensembl_gene_id', 'gene_biotype'), 
  filters = 'ensembl_gene_id', 
  values = aml.fpkms.prob.hg38$ensembl, 
  mart = ensembl)

# index of all protein coding genes
all_protein_coding <- gene_biotype[gene_biotype$gene_biotype=="protein_coding", ]$ensembl_gene_id
ix <- which(aml.fpkms.prob.hg38$ensembl %in% all_protein_coding)

# subset matrix
pediatric_aml_intermediate <- subset.genes.prob.target(aml.fpkms.prob.hg38, ix)

# only select genes with a median FPKM >1
ix <- which(rowMedians(pediatric_aml$mRNA) > 1)
pediatric_aml <- subset.genes.prob.target(pediatric_aml_intermediate, ix)

# change codex for survival (death=1, alive=0), needed for cox regression
pediatric_aml$surv.data <-  data.frame(time=pediatric_aml$survival[,1], 
           status=ifelse(pediatric_aml$survival[,2]==0,1,0))

```


Prognostic genes from TCGA/TARGET.
```{r}
#### TCGA ----------------------------------------------------------------------
# select LAML only
ix <- which(prob0$types=="LAML")
prob.adult.aml <- subset.prob(prob0,ix)

### TARGET ---------------------------------------------------------------------

surv_mat <- data.frame(
  samples=pediatric_aml$samples,
  sex=pediatric_aml$sex,
  age=pediatric_aml$age,
  race=pediatric_aml$race,
  ethnicity=pediatric_aml$ethnicity,
  tissue=pediatric_aml$tissue,
  time=pediatric_aml$surv.data$time,
  status=pediatric_aml$surv.data$status)

# merge and transform data
# take log2 of FPKM values
cox_data <- cbind(surv_mat, t(log2(pediatric_aml$mRNA + 1)))
scaled_data <- cbind(surv_mat, scale(t(log2(pediatric_aml$mRNA + 1 ))))

# Run Cox in parallel
res <- RegParallel(
  data = cox_data,
  formula = 'Surv(time, status) ~ [*] + age + strata(sex, race, ethnicity, tissue)',
  FUN = function(formula, data)
    coxph(formula = formula,
          data = data,
          ties = 'efron'),
  FUNtype = 'coxph',
  variables = colnames(cox_data)[9:ncol(cox_data)],
  blocksize = 1000,
  cores = 2,
  nestedParallel = FALSE,
  conflevel = 95,
  p.adjust = "BH")

# Annotate results
res_noAge <- res[res$Term!="age", ]
gene_hgnc<- getBM(
  attributes = c('ensembl_gene_id', 'hgnc_symbol'), 
  filters = 'ensembl_gene_id', 
  values = res_noAge$Variable, 
  mart = ensembl)

# Merge annotation
m.res <- merge(res_noAge, gene_hgnc, by.x="Variable", by.y="ensembl_gene_id", all.x = TRUE)

# Plot results
m.res[order(m.res$P, decreasing=FALSE), ]

# Plot Hazard ratio vs P value
p <- ggplot(data=m.res, aes(x=log2(HR), y=-log10(P)))
p <- p + geom_point(fill="blue", colour="white", pch=21, alpha=0.5, size=2.5)
p <- p + geom_point(data=m.res[m.res$P.adjust < 0.05, ], 
                    aes(x=log2(HR), y=-log10(P)),
                    fill="red", colour="white", pch=21, alpha=0.5, size=2.5)
p <- p + geom_text_repel(data=m.res[m.res$P.adjust < 0.05 & log2(m.res$HR) > 0 , ], 
                         aes(x=log2(HR), y=-log10(P), label=hgnc_symbol), 
                         color="red")
p <- p + geom_text_repel(data=m.res[m.res$P.adjust < 0.05 & log2(m.res$HR) < 0 , ], 
                         aes(x=log2(HR), y=-log10(P), label=hgnc_symbol), 
                         color="blue")
p <- p + coord_fixed(ratio = 1)
p <- p + theme_bw()
p <- p + theme(axis.text.x=element_text(colour="black", size=10), 
               axis.text.y=element_text(colour="black", size=10))
print(p)

fn <- sprintf(paste(dir.figures, "cox_covar_age.sex.race.ethnicity.pdf", sep=""))
pdf(fn, height=6, width=6)
print(p)
dev.off()

 
```

Plot survival (Kaplan Maier plots).
```{r}
# try example with one gene

km.gene.obj <- function(cox_data, scaled_data=scaled_data, gene=gene, gene_symbol=gene_symbol){
  cox.g1 <- cox_data[, c("samples", "sex", "age", "race", "tissue", "time", "status", gene)]

  #survplotdata <- scaled_data[,c('time', 'status', gene)]
  #colnames(survplotdata) <- c('time', 'status', gene_symbol)

  # set Z-scale cut-offs for high and low expression
  #highExpr <- 1.0
  #lowExpr <- -0.5
  #survplotdata[[gene_symbol]] <- ifelse(survplotdata[[gene_symbol]] >= highExpr, 'High',
  #                        ifelse(survplotdata[[gene_symbol]] <= lowExpr, 'Low', 'Mid'))
  # relevel the factors to have mid as the ref level
  #survplotdata[[gene_symbol]] <- factor(survplotdata[[gene_symbol]] ,
  #                         levels = c('Mid', 'Low', 'High'))
  
  # different approach
  cox.g1[[gene_symbol]] <- xtile(cox.g1[[gene]], 3)

  return(cox.g1)
}

survplotdata <- km.gene.obj(
  cox_data=cox_data,
  scaled_data=scaled_data,
  gene="ENSG00000067048", 
  gene_symbol = "DDX3Y")

p <- ggsurvplot(
  survfit(Surv(time, status) ~ DDX3Y, data = survplotdata),
  data = survplotdata,
  risk.table = TRUE,
  pval = FALSE,
  break.time.by = 500,
  ggtheme = theme_minimal(),
  risk.table.y.text.col = TRUE,
  risk.table.y.text = FALSE)

fn <- sprintf(paste(dir.figures, "kaplan_maier_DDX3Y.pdf", sep=""))
pdf(fn, height=6, width=6)
print(p)
dev.off()

```

Mine AML (adult & pediatric cell lines).
```{r}
# Mine adult and pediatric cell line separtely. 


```

Example.
```{r}
# Tutorial from https://www.biostars.org/p/344233/

```


