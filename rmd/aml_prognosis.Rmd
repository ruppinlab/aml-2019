# 

Load libraries.
```{r}
library(biomaRt)
library(survival)
library(RegParallel)
library(survminer)
```

Set directories.
```{r}
dir.output <- "~/datasets/SLpediatric/sl_pairs_results/"
dir.figures <- "~/Google Drive/NIH_NCI/Projects/SL_pediatric/"
dir.code <- "~/datasets/SLpediatric/R/"
dir.repo <- "~/src/SLpediatric/R/"
dir.rdata <- "~/datasets/SLpediatric/Rdata_object/version6_nbl1-3/"
dir.ppi <- "~/datasets/STRING/"
dir.depmap <- "~/datasets/DepMap/"
dir.aml <- "~/datasets/SLpediatric/Rdata_object/version2_CDSI/"
dir.target <- "/Users/schischlikf2/datasets/SLpediatric/datasets/TARGET/"
```

Recurrent used functions.
```{r}

subset.prob.tcga <- function(prob, ix){
  
  prob$samples=prob$samples[ix]
  prob$types=prob$types[ix]
  prob$mRNA=prob$mRNA[,ix]
  prob$scna=prob$scna[,ix]
  prob$mRNAq=prob$mRNAq[,ix]
  prob$scnaq=prob$scnaq[,ix]
  prob$mRNAq2=prob$mRNAq2[,ix]
  prob$scnaq2=prob$scnaq2[,ix]
  prob$sex=prob$sex[ix]
  prob$age=prob$age[ix]
  prob$race=prob$race[ix]
  prob$survival=prob$survival[ix,]
  prob$stage=prob$stage[ix]
  prob$mRNA.norm=prob$mRNA.norm[,ix]
  prob$scna.norm=prob$scna.norm[,ix]
  prob$surv.dt=prob$surv.dt[ix,]
  
  return(prob)
}

subset.genes.prob.target <- function(prob, ix){
  prob$genes <- prob$genes[ix]
  prob$ensembl <- prob$ensembl[ix]
  prob$ensembl_version <- prob$ensembl_version[ix]
  prob$scna <- prob$scna[ix, ]
  prob$mRNA <- prob$mRNA[ix, ]
  prob$samples <- prob$samples
  prob$types <- prob$types
  prob$mutations <- prob$mutations
  prob$sex <- prob$sex
  prob$age <- prob$age
  prob$race <- prob$race
  prob$ethnicity <- prob$ethnicity
  prob$survival <- prob$survival
  prob$eventfree <- prob$eventfree
  
  return(prob) 
}

```

Load data.
```{r}
# load depmap data
load(paste(dir.depmap, "depmap_19Q3.RData", sep=""))
# load TCGA data
load(paste(dir.code, "prob.TCGA.extended.qnorm.RData", sep=""));prob0=prob
rm(prob)
# load TARGET data
load(paste(dir.aml, "aml.fpkms.n145.hg38.prob.Rdata", sep="")) # prob_name=aml.fpkms.prob.hg38
# tissue code information for TARGET data
#tissue_code <- read.csv(
#  paste(dir.target, "tissue_code.csv", sep=""), 
#  colClasses=c("character", "character", "character"))
```

Preprocess TARGET data.
```{r}
# add tissue information to include in Cox regression
#df.aml <- data.frame(
#  sample.names=colnames(aml.fpkms.prob.hg38),
#  tissue.code=substr(colnames(aml.fpkms.prob.hg38), 18, 19)
#  )
#tissue.code.aml <- merge(df.aml, tissue.code, by.x="tissue.code", by.y="Code")

# only select protein coding genes
aml.fpkms.prob.hg38$ensembl_version <- aml.fpkms.prob.hg38$ensembl
aml.fpkms.prob.hg38$ensembl <- sapply(aml.fpkms.prob.hg38$ensembl_version, 
                                      function(x) strsplit(as.character(x), split="\\.")[[1]][1])
row.names(aml.fpkms.prob.hg38$mRNA) <- aml.fpkms.prob.hg38$ensembl

ensembl <- useMart(
  "ensembl", 
  dataset="hsapiens_gene_ensembl")

gene_biotype <- getBM(
  attributes = c('ensembl_gene_id', 'gene_biotype'), 
  filters = 'ensembl_gene_id', 
  values = aml.fpkms.prob.hg38$ensembl, 
  mart = ensembl)

# index of all protein coding genes
all_protein_coding <- gene_biotype[gene_biotype$gene_biotype=="protein_coding", ]$ensembl_gene_id
ix <- which(aml.fpkms.prob.hg38$ensembl %in% all_protein_coding)

# subset matrix
pediatric_aml <- subset.genes.prob.target(aml.fpkms.prob.hg38, ix)

# change codex for survival
pediatric_aml$surv.data <-  data.frame(time=pediatric_aml$survival[,1], 
           status=ifelse(pediatric_aml$survival[,2]==0,1,0))

```


Prognostic genes from TCGA/TARGET.
```{r}
#### TCGA ----------------------------------------------------------------------
# select LAML only
ix <- which(prob0$types=="LAML")
prob.adult.aml <- subset.prob(prob0,ix)

### TARGET ---------------------------------------------------------------------

surv_mat <- data.frame(
  samples=pediatric_aml$samples,
  sex=pediatric_aml$sex,
  age=pediatric_aml$age,
  race=pediatric_aml$race,
  ethnicity=pediatric_aml$ethnicity,
  time=pediatric_aml$surv.data$time,
  status=pediatric_aml$surv.data$status)

# merge and transform data
cox_data <- cbind(surv_mat, t(pediatric_aml$mRNA))
scaled_data <- cbind(surv_mat, scale(t(pediatric_aml$mRNA)))

# Run Cox in parallel
res <- RegParallel(
  data = cox_data,
  formula = 'Surv(time, status) ~ [*] + age + strata(sex, race)',
  FUN = function(formula, data)
    coxph(formula = formula,
          data = data,
          ties = 'efron'),
  FUNtype = 'coxph',
  variables = colnames(cox_data)[9:ncol(cox_data)],
  blocksize = 1000,
  cores = 2,
  nestedParallel = FALSE,
  conflevel = 95,
  p.adjust = "BH")

res <- res[!is.na(res$P),]
res

# try example with one gene
cox.g1 <- cox_data[, c("samples", "sex", "age", "race", "time", 
                       "status", "ENSG00000135002")]
cox_obj <- coxph(Surv(time, status) ~ ENSG00000135002 + age + strata(sex, race), data= cox.g1)

# extract RFS and probe data for downstream analysis
survplotdata <- scaled_data[,c('time', 'status',
                               'ENSG00000135002')]
colnames(survplotdata) <- c('time', 'status', 'RFK')

# set Z-scale cut-offs for high and low expression
highExpr <- 1.0
lowExpr <- -1.0
survplotdata$RFK<- ifelse(survplotdata$RFK >= highExpr, 'High',
                          ifelse(survplotdata$RFK <= lowExpr, 'Low', 'Mid'))

# relevel the factors to have mid as the ref level
survplotdata$RFK <- factor(survplotdata$RFK,
                           levels = c('Mid', 'Low', 'High'))

ggsurvplot(survfit(Surv(time, status) ~ RFK,
                   data = survplotdata),
           data = survplotdata,
           risk.table = TRUE,
           pval = TRUE,
           break.time.by = 500,
           ggtheme = theme_minimal(),
           risk.table.y.text.col = TRUE,
           risk.table.y.text = FALSE)

```

Mine AML (adult & pediatric cell lines).
```{r}
# Mine adult and pediatric cell line separtely. 


```

Example.
```{r}
# Tutorial from https://www.biostars.org/p/344233/
#### Read in and prepare data ------------------------------------------------------

library(Biobase)
library(GEOquery)

# load series and platform data from GEO
gset <- getGEO('GSE2990', GSEMatrix =TRUE, getGPL=FALSE)
x <- exprs(gset[[1]])

# remove Affymetrix control probes
x <- x[-grep('^AFFX', rownames(x)),]

# transform the expression data to Z scores
x <- t(scale(t(x)))

# extract information of interest from the phenotype data (pdata)
idx <- which(colnames(pData(gset[[1]])) %in%
               c('age:ch1', 'distant rfs:ch1', 'er:ch1',
                 'ggi:ch1', 'grade:ch1', 'node:ch1',
                 'size:ch1', 'time rfs:ch1'))

metadata <- data.frame(pData(gset[[1]])[,idx],
                       row.names = rownames(pData(gset[[1]])))

# remove samples from the pdata that have any NA value
discard <- apply(metadata, 1, function(x) any( is.na(x) ))
metadata <- metadata[!discard,]

# filter the Z-scores expression data to match the samples in our pdata
x <- x[,which(colnames(x) %in% rownames(metadata))]

# check that sample names match exactly between pdata and Z-scores 
all((colnames(x) == rownames(metadata)) == TRUE)
## [1] TRUE

# create a merged pdata and Z-scores object
coxdata <- data.frame(metadata, t(x))

# tidy column names
colnames(coxdata)[1:8] <- c('Age', 'Distant.RFS', 'ER',
                            'GGI', 'Grade', 'Node',
                            'Size', 'Time.RFS')

# prepare phenotypes
coxdata$Distant.RFS <- as.numeric(coxdata$Distant.RFS)
coxdata$Time.RFS <- as.numeric(gsub('^KJX|^KJ', '', coxdata$Time.RFS))
coxdata$ER <- factor(coxdata$ER, levels = c(0, 1))
coxdata$Grade <- factor(coxdata$Grade, levels = c(1, 2, 3))


##### Test each gene independently via Cox regression --------------------------

library(survival)
library(RegParallel)

res <- RegParallel(
  data = coxdata,
  formula = 'Surv(Time.RFS, Distant.RFS) ~ [*]',
  FUN = function(formula, data)
    coxph(formula = formula,
          data = data,
          ties = 'breslow',
          singular.ok = TRUE),
  FUNtype = 'coxph',
  variables = colnames(coxdata)[9:ncol(coxdata)],
  blocksize = 2000,
  cores = 2,
  nestedParallel = FALSE,
  conflevel = 95)
res <- res[!is.na(res$P),]
res


```


